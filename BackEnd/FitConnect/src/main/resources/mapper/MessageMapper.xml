<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Message">
	
	
	<insert id="insertChat" parameterType="chatRoomDto">
		INSERT INTO chat_room 
		(chat_id, member_num, trainer_num, topic) 
		VALUES (chat_id_seq.NEXTVAL, #{member_num}, #{trainer_num}, #{topic})

	</insert>
	<select id="getChatRoom" resultType="chatRoomDto" parameterType="int">
		SELECT chat_id, member_num, trainer_num, topic
		FROM chat_room
		WHERE member_num=#{user_id} OR trainer_num=#{user_id}
	</select>
	<select id="getChatAll" resultType="chatRoomDto" parameterType="int">
		SELECT cr.chat_id, cr.member_num, cr.trainer_num, cr.topic, ui.name, ui.profile, m.content, MAX(to_char(times, 'YYYY-MM-DD HH24:MI')) as times
		FROM chat_room cr 
		JOIN user_info ui ON cr.member_num=ui.id
		JOIN chat_message m ON cr.trainer_num=#{trainer_num}
		GROUP BY cr.chat_id, cr.member_num, cr.trainer_num, cr.topic, ui.name, ui.profile, m.content
		ORDER BY times ASC
	</select>
	<select id="getMsgAll" resultType="messageDto" parameterType="string">
		SELECT message_id, topic, content, send_type, to_char(times, 'YYYY-MM-DD HH24:MI') as times
		FROM chat_message 
		WHERE topic=#{topic}
		ORDER BY times ASC
	</select>
	<insert id="insertMsg" parameterType="messageDto">
		INSERT INTO chat_message
		(message_id, topic, content, send_type, times)
		VALUES (message_id_seq.NEXTVAL, #{topic}, #{content}, #{send_type}, CURRENT_TIMESTAMP)
	</insert>
	<delete id="deleteMsg" parameterType="int">
		DELETE FROM chat_message
		WHERE message_id=#{message_id}
	</delete>
	<delete id="deleteChat" parameterType="string">
		{CALL
	    BEGIN
			DELETE FROM chat_message
			WHERE topic=#{topic};
			DELETE FROM chat_room
			WHERE topic=#{topic};
		   END}
	</delete>
	
	
</mapper>